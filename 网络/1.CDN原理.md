https://mp.weixin.qq.com/s/c9JZSkGPWvK5n4NVfK5sKg

什么是CDN?
和域名系统类似，内容分发网络（Content Dilivery Network，CDN）是一个专门用来分发内容的分布式应用。CDN 构建在现有的互联网之上，通过在各地部署数据中心，让不同地域的用户可以就近获取内容。

这里的内容通常指的是文件、图片、视频、声音、应用程序安装包等，它们具有一个显著的特征——无状态，或者说是静态的。

CDN旨在解决的最重要的问题就是网络延迟，CDN服务商会将源站的资源缓存到遍布全国的高性能加速节点上，当用户访问相应的业务资源时，用户会被调度至最接近的节点最近的节点IP返回给用户，在web性能优化中，它主要起到了，缓解源站压力，优化不同用户的访问速度与体验的作用。

每次的资源请求发起时，浏览器都会检测本地是否有缓存并且未过期，如果是，则直接使用缓存，否则则会向服务端发起请求。如果此时在浏览器和服务器之间增加一层CDN服务，整个访问过程会是什么样的呢？

客户端浏览器先检查是否有本地缓存是否过期，如果过期，则向CDN边缘节点发起请求，CDN边缘节点会检测用户请求数据的缓存是否过期。如果没有过期，则直接响应用户请求，此时一个完成http请求结束；如果数据已经过期，那么CDN还需要向源站发出回源请求（back to the source request），来拉取最新的数据。

可以看出，CDN的优点很明显了：

- CDN节点解决了跨运营商和跨地域访问的问题，访问延时大大降低；
- 大部分请求在CDN边缘节点完成，CDN起到了分流作用，减轻了源站的负载。


CDN 的工作原理 就是将源站的资源缓存CDN各个节点上，当请求命中了某个节点的资源缓存时，立即返回客户端，避免每个请求的资源都通过源站获取，避免网络拥塞、缓解源站压力，保证用户访问资源的速度和体

1.客户端访问某个域名的时候，会先查找本地hosts文件，如果能查到ip就直接访问

2.否则会向本地DNS服务器发请求，联通、移动等运营商提供的每个城市都有的DNS服务器。由它去 域名服务器发送解析域名的请求，然后把结果返回给客户端

3.域名是分层解析的。
有根域名服务器、
顶级域名服务器、
权威域名服务器三层

比如image.baidu.com会先向根域名服务器发起请求查询com的顶级域名服务器的ip，
然后再向com顶级域名服务器查询image。baidu.com的权威服务器ip，查询到权威域名服务器后，任意层级的域名都会在这里解析

看到这个权威域名服务器的时候，不知道大家是否就想到怎么实现 CDN 网络了。
能不能在权威域名服务器这一层根据客户端的 ip 做一下负载均衡呢？比如北京来的 DNS 请求就返回北京机房的服务器的 ip，上海来的 DNS 请求就返回上海机房的服务器的 ip。

确实可以这样实现内容的就近分发，这样的负载均衡网络就叫做 CDN （Content Delivery Network）

但是实现这样一个 CDN 网络需要在全国建立多个机房，成本太高了，所以只有像百度、阿里、腾讯这类大公司才会自建 CDN，一般情况下我们都会买第三方的 CDN 服务来用。

这些公司建好了 CDN 网络，实际上自己也是用不完的，也会对外提供 CDN 加速服务。

第三方的 CDN 服务自然也要提供一个 DNS 服务器，也就是实现根据 ip 返回不同城市的服务器的 ip 的那个。



用户向本地 DNS 服务器发请求之后，经历根域名、顶级域名的 DNS 解析，最终会转给权威 DNS 服务器。这时候只要权威 DNS 服务器再转给 baidu 的 DNS 服务器就可以了，这样就能接入 CDN 服务。

baidu 的 DNS 服务器实现了负载均衡，会根据请求 ip 所在的城市，返回不同城市的服务器的 ip。也就实现了就近分发的网络加速功能

那这个从权威 DNS 到 baidu 的 DNS 的转发是怎么实现的呢？

DNS 的记录有很多种类型，比如：

A 代表 address，记录域名对应的 ip。


CNAME 代表域名还有一个别名，可以向那个域名来查 ip。

看到这个 CNAME 类型，大家应该就想到怎么实现转发了。

只要自己在 DNS服务器上配一条 CNAME 的记录，指向 CDN 服务器的域名就可以了。


比如你用某云的 CDN 的时候，第一步也是要配置下自己的 DNS 服务器的 CNAME 指向它：

这样，当你访问某个域名的时候，解析域名的权威服务器会返回 CDN 服务的 DNS 服务器的域名，然后再向这台 CDN 的 DNS 服务器发送解析域名的请求，这时候它就可以根据 ip 所在城市来返回一个就近城市的服务

当然，也可以再做一层 CNAME 转发，比如 CDN 的 DNS 服务器把域名解析转给城市的 DNS 服务器，然后城市的 DNS 服务器再根据不同机器的负载情况来返回一台离得近而且负载比较小的服务器的 ip 给客户端。
这样客户端就能从最近的服务器下载静态资源，从而更快地打开网站


为了加快网站打开速度，我们会使用 CDN 服务，它并不是一个网络协议，只是基于 DNS 协议实现的加速功能的系统。

它的原理就是域名的权威 DNS 服务器把请求转给 CDN 的负载均衡的 DNS 服务器，然后根据 ip返回不同城市的 DNS 服务器，再根据负载来选择一台就近的服务器 的 ip 返回

这样客户端就能从最近的负载最小的服务器拿到资源。

CNAME和A记录，它们是理解CDN的基础概念。

- CNAME记录，也叫别名记录，比如http://www.xx.com的别名是http://www.yy.com，CNAME记录是一种指向关系，把http://www.yy.com指向了http://www.xx.com，一个域名可以有多个别名，存在多对一的关系。
- A记录，即Address记录，我们可以把它理解为一种域名和IP地址的映射关系。

由于加速域名已经进行了CDN的CNAME配置，在权威DNS服务器的解析下得到的并不是IP地址，而是CNAME。

当用户访问http://abc.com时，传统的权威DNS服务器对http://abc.com进行解析时得到的是http://abc.com.aliyuncdn.net这个配置的CNAME，从而通过CNAME顺利将请求转到CDN服务商专用的DNS服务器，由该服务器返回CDN的资源节点。


当用户请求一个静态资源的时候，首先会触发域名系统的解析。域名系统会将解析的责任交由 CDN 提供商来处理，CDN 的智能 DNS 服务会帮助用户选择离自己距离最近的节点，返回这个节点的 A（或 AAAA）记录。然后客户端会向 CDN 的资源节点发起请求，最终获得资源。

