https://mp.weixin.qq.com/s/Gl94ISY5N4BYyYmVT9-QFQ

那怎么维护这个域名和 IP 的映射关系呢？

最简单的方式就是在一个文件里记录下所有的域名和 IP 的对应关系，每次解析域名的时候都到这个文件里查一下。

最开始确实是这么设计的，这样的文件叫做 hosts 文件，记录了世界上所有的主机（host）。

那时候全世界也没多少机器，所以这样的方式是可行的。

但是随着机器的增多，这种方式就不太行了，有两个突出的问题：

- 全世界都从某一台机器来同步配置，这台机器压力会太大。
- 当域名多了以后，命名上很容易冲突

所以域名服务器得是分布式的，通过多台服务器来提供服务，并且最好还能通过命名空间来划分，减少命名冲突。

因此才产生了域名，例如 baidu.com 这个 com 就是一个域，叫顶级域，baidu 就是 com 域的二级域，接着有三级域、四级域

但是这样设计还是有问题的，每一级域一个服务器，如果域名的层次过多，那么就要往返查询好多次，效率也不高。

所以 DNS（Domain Name System）只分了三级域名服务器：
- 根域名服务器：记录着所有顶级域名服务器的地址，是域名解析的入口 
- 顶级域名服务器：记录着各个二级域名对应的服务器的地址 “com”、“net”、“cn”等顶级域名服务器
- 权威域名服务器：该域下二级、三级甚至更多级的域名都在这里解析

其实就是把二、三、四、五甚至更多级的域名都合并在一个服务器解析了，叫做权威域名服务器

当然，每次查询还是比较耗时的，查询完之后要把结果缓存下来，并且设置一个过期时间，域名解析记录在 DNS 服务器上的缓存时间叫做 TTL（Time-To-Live）。

但现在只是在某一台机器上缓存了这个解析结果，可能某个区域的其他机器在访问的时候还是需要解析的。

所以 DNS 设计了一层本地域名服务器，由它来负责完成域名的解析，并且把结果缓存下来。

这样某台具体的机器只要向这个本地域名服务器发请求就可以了，而且解析结果其他机器也可以直接用。

这样的本地域名服务器是移动、联通等 ISP（因特网服务提供商）提供的，一般在每个城市都有一个。某台机器访问了某个域名，解析之后会把结果缓存下来，其他机器访问这个域名就不用再次解析了。


# 域名缓存

本地域名服务器缓存：各大域名服务商或大公司都有自己的DNS服务器，一般部署在距离用户较近地方，代替用户访问核心dns系统。可以缓存之前的查询结果。如果有了记录，就无需再向根服务器发起查询，直接返回ip地址

本地计算机dns记录缓存
-  浏览器缓存，浏览器获取某一网站域名的实际ip地址后，进行缓存，之后遇到同一域名查询之前的缓存结果即可，有效减少网络请求的损耗。例如chrome的过期时间是1分钟，在这个期限内不会重新请求DNS
- 操作系统缓存
操作系统里有一个“主机映射”文件，/etc/hosts，如果操作系统在缓存里找不到dns记录，就会找这个文件

DNS完整查询过程：
1.首先搜索浏览器的dns缓存
2.如果没有命中，则继续搜索操作系统的dns缓存
3.如果依然没有命中，则操作系统将域名发送至本地域名服务器，本地域名服务器查询自己的dns缓存，如果查找成功则返回结果
4.若本地域名服务器dns缓存没有命中，则本地域名服务器向上级域名服务器进行查询
5.首先本地域名服务器向根域名服务器发起请求，根域名返回顶级域名服务器的地址
6.本地域名服务器拿到顶级域名服务器的地址后，则向其发起请求，获取权威域名服务器的地址
7.本地域名服务器向权威域名服务器发起请求，最终得到该域名对应的ip地址
8.本地域名服务器将得到的ip地址返回给操作系统，同时自己将ip地址缓存起来
9.操作系统将ip地址返回给浏览器，同时自己也将ip地址缓存起来
10.浏览器得到了域名的ip地址，并将ip地址缓存了起来